<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <title>Skenov√°n√≠ QR a ƒç√°rov√Ωch k√≥d≈Ø (ZXing)</title>
  <script src="https://unpkg.com/@zxing/browser@0.1.5"></script>
  <style>
    body { font-family: sans-serif; text-align: center; background:#f4f4f4; margin:0; padding:20px; }
    #video { width:480px; height:360px; border:2px solid #4CAF50; border-radius:12px; background:black; }
    select, button, input { margin:8px; padding:8px; font-size:1rem; border-radius:8px; }
    button { background:#4CAF50; color:white; border:none; cursor:pointer; }
    #status { margin-top:10px; font-weight:bold; }
  </style>
</head>
<body>
  <h2>Skenov√°n√≠ k√≥d≈Ø</h2>

  <!-- v√Ωbƒõr kamery + rozli≈°en√≠ -->
  <select id="cameraSelect"></select>
  <select id="resolutionSelect">
    <option value="360">360p</option>
    <option value="720" selected>720p</option>
    <option value="1080">1080p</option>
  </select>

  <div>
    <button id="startBtn">Spustit</button>
    <button id="stopBtn">Zastavit</button>
  </div>

  <div>
    <video id="video" autoplay muted playsinline></video>
  </div>

  <div id="status">P≈ôipraven</div>
  <input id="result" placeholder="V√Ωsledek" readonly />

  <script>
    const { BrowserMultiFormatReader } = window.ZXingBrowser;
    const codeReader = new BrowserMultiFormatReader();
    let controls = null;

    const cameraSelect = document.getElementById('cameraSelect');
    const resolutionSelect = document.getElementById('resolutionSelect');
    const videoElem = document.getElementById('video');
    const statusElem = document.getElementById('status');
    const resultInput = document.getElementById('result');

    async function loadCameras() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(d => d.kind === 'videoinput');
        cameraSelect.innerHTML = "";
        if (videoDevices.length === 0) {
          const opt = document.createElement("option");
          opt.textContent = "≈Ω√°dn√° kamera nenalezena";
          cameraSelect.appendChild(opt);
          statusElem.textContent = "‚ùå ≈Ω√°dn√° kamera";
          return;
        }
        videoDevices.forEach((d,i) => {
          const opt = document.createElement("option");
          opt.value = d.deviceId;
          opt.textContent = d.label || `Kamera ${i+1}`;
          cameraSelect.appendChild(opt);
        });
        statusElem.textContent = "üì∑ Kamery naƒçteny";
      } catch (err) {
        statusElem.textContent = "Chyba p≈ôi z√≠sk√°v√°n√≠ kamer: " + err;
      }
    }

    async function startScan() {
      stopScan();
      resultInput.value = "";
      const deviceId = cameraSelect.value || undefined;
      const res = parseInt(resolutionSelect.value);

      try {
        controls = await codeReader.decodeFromConstraints(
          {
            video: {
              deviceId: deviceId ? { exact: deviceId } : undefined,
              width: { ideal: res },
              height: { ideal: Math.round(res * 3/4) }, // 4:3 pomƒõr stran
              facingMode: "environment"
            }
          },
          videoElem,
          (result, err) => {
            if (result) {
              resultInput.value = result.getText();
              statusElem.textContent = "‚úÖ Naƒçteno: " + result.getText();
              stopScan(); // zastav√≠ po naƒçten√≠
            }
          }
        );
        statusElem.textContent = "üì° Skenov√°n√≠ bƒõ≈æ√≠ na " + res + "p";
      } catch (err) {
        statusElem.textContent = "Chyba spu≈°tƒõn√≠: " + err;
        console.error(err);
      }
    }

    function stopScan() {
      if (controls) {
        controls.stop();
        controls = null;
      }
      statusElem.textContent = "‚èπÔ∏è Skenov√°n√≠ zastaveno";
    }

    document.getElementById("startBtn").addEventListener("click", startScan);
    document.getElementById("stopBtn").addEventListener("click", stopScan);

    loadCameras();

    if (location.protocol !== "https:" && location.hostname !== "localhost") {
      statusElem.textContent = "‚ö†Ô∏è Kamera funguje jen na HTTPS nebo localhost!";
    }
  </script>
</body>
</html>
