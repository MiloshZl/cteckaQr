<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Skenov√°n√≠ QR / ƒå√°rov√©ho k√≥du</title>

  <!-- Bootstrap 5.3 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- ZXing knihovna -->
  <script src="https://unpkg.com/@zxing/browser@0.1.5"></script>

  <style>
    #video {
      width: 100%;
      max-width: 640px;
      height: auto;
      border: 3px solid #198754;
      border-radius: 1rem;
      background: black;
    }
    #status { margin-top: 1rem; font-weight: bold; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="text-center mb-4">üì∑ Skenov√°n√≠ QR / ƒå√°rov√©ho k√≥du</h1>

    <div class="row justify-content-center">
      <div class="col-md-8 text-center">

        <!-- V√Ωbƒõr kamery -->
        <select id="cameraSelect" class="form-select mb-2"></select>

        <!-- Video -->
        <video id="video" autoplay muted playsinline></video>

        <!-- Ovl√°dac√≠ tlaƒç√≠tka -->
        <div class="mt-3">
          <button id="startBtn" class="btn btn-success me-2">Spustit skenov√°n√≠</button>
          <button id="stopBtn" class="btn btn-danger">Zastavit</button>
        </div>

        <div id="status" class="text-primary">P≈ôipraven</div>

        <input id="result" class="form-control mt-3 text-center" placeholder="V√Ωsledek" readonly>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const { BrowserMultiFormatReader } = window.ZXingBrowser;
    const codeReader = new BrowserMultiFormatReader();
    let controls = null;

    const cameraSelect = document.getElementById('cameraSelect');
    const videoElem = document.getElementById('video');
    const statusElem = document.getElementById('status');
    const resultInput = document.getElementById('result');

    // Vyhledej v≈°echny zadn√≠ kamery
    async function loadCameras() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const backCameras = devices.filter(d => d.kind === 'videoinput' &&
          (d.label.toLowerCase().includes('back') || d.label.toLowerCase().includes('zadn√≠')));

        if (backCameras.length === 0) {
          // fallback ‚Äì v≈°echny kamery
          backCameras.push(...devices.filter(d => d.kind === 'videoinput'));
        }

        cameraSelect.innerHTML = '';
        backCameras.forEach((cam, i) => {
          const opt = document.createElement('option');
          opt.value = cam.deviceId;
          opt.textContent = cam.label || `Kamera ${i+1}`;
          cameraSelect.appendChild(opt);
        });

        statusElem.textContent = `üì∑ Vyber kameru (zadn√≠ pokud je k dispozici)`;
      } catch (err) {
        statusElem.textContent = `‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ kamer: ${err}`;
        console.error(err);
      }
    }

    async function startScan() {
      stopScan();
      resultInput.value = '';
      const deviceId = cameraSelect.value;

      try {
        controls = await codeReader.decodeFromConstraints(
          {
            video: {
              deviceId: deviceId ? { exact: deviceId } : undefined,
              width: { ideal: 1920 },
              height: { ideal: 1080 },
            }
          },
          videoElem,
          (result, err) => {
            if (result) {
              resultInput.value = result.getText();
              statusElem.textContent = "‚úÖ Naƒçteno: " + result.getText();
              stopScan();
            }
          }
        );
        statusElem.textContent = `üì° Skenov√°n√≠ bƒõ≈æ√≠ (kamera: ${cameraSelect.selectedOptions[0].text})`;
      } catch (err) {
        statusElem.textContent = `‚ùå Chyba: ${err}`;
        console.error(err);
      }
    }

    function stopScan() {
      if (controls) {
        controls.stop();
        controls = null;
      }
      statusElem.textContent = "‚èπÔ∏è Skenov√°n√≠ zastaveno";
    }

    document.getElementById("startBtn").addEventListener("click", startScan);
    document.getElementById("stopBtn").addEventListener("click", stopScan);

    loadCameras();

    if (location.protocol !== "https:" && location.hostname !== "localhost") {
      statusElem.textContent = "‚ö†Ô∏è Kamera funguje jen na HTTPS nebo localhost!";
    }
  </script>
</body>
</html>
